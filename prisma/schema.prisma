// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =========================
// ENUM
// =========================

enum StatusKaryawan {
  AKTIF
  NONAKTIF
}

enum TipeCutiTahunan {
  PROBATION
  PRORATE
  FULL
}

enum JenisCuti {
  TAHUNAN
  SAKIT
  IZIN
  BAKU
  TANPA_KETERANGAN
  LAINNYA
}

enum StatusKehadiran {
  HADIR
  SAKIT
  IZIN
  WFH
  TANPA_KETERANGAN
  CUTI
  CUTI_BAKU
  SECURITY
  TUGAS
  BELUM_FINGERPRINT
}

enum KategoriItem {
  ATK
  OBAT
}

enum TipeDiscount {
  BONUS      // Discount berupa bonus (nominal tetap)
  PERSEN     // Discount berupa persentase
}

// =========================
// MODEL KARYAWAN (MASTER)
// =========================

model Karyawan {
  id            String         @id @default(uuid())
  nik           String         @unique
  fingerprintId Int?           @unique
  nama          String
  jabatan       String?
  departemen    String?
  tanggalMasuk  DateTime
  status        StatusKaryawan @default(AKTIF)

  cutiTahunan   CutiTahunan[]
  cuti          Cuti[]
  absensi       Absensi[]

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

// =========================
// MODEL CUTI TAHUNAN
// 1 karyawan = 1 record per tahun
// =========================

model CutiTahunan {
  id             String          @id @default(uuid())
  karyawanId     String
  tahun          Int

  jatahDasar     Int             // 0 / 7 / 12
  carryForward   Int             @default(0)
  totalHakCuti   Int             // jatahDasar + carryForward
  cutiTerpakai   Int             @default(0)
  sisaCuti       Int

  tipe           TipeCutiTahunan // PROBATION / PRORATE / FULL

  karyawan       Karyawan        @relation(fields: [karyawanId], references: [id])
  cuti           Cuti[]

  createdAt      DateTime        @default(now())

  @@unique([karyawanId, tahun])
}

// =========================
// MODEL TRANSAKSI CUTI
// (Pencatatan langsung, tanpa approval)
// =========================

model Cuti {
  id             String        @id @default(uuid())
  karyawanId     String
  cutiTahunanId  String

  tahun          Int
  jenis          JenisCuti
  alasan         String?

  tanggalMulai   DateTime
  tanggalSelesai DateTime
  jumlahHari     Int

  karyawan       Karyawan      @relation(fields: [karyawanId], references: [id])
  cutiTahunan    CutiTahunan   @relation(fields: [cutiTahunanId], references: [id])

  createdAt      DateTime      @default(now())
}

// =========================
// MODEL INVENTORY
// =========================

model Item {
  id              String          @id @default(uuid())
  kode            String          @unique
  nama            String
  kategori        KategoriItem
  satuan          String          // pcs, box, rim, botol, tablet, strip, dll
  stokMinimal     Int             @default(0)
  stokSekarang    Int             @default(0)
  keterangan      String?

  pembelian       Pembelian[]
  pengeluaran     Pengeluaran[]
  strukItem       StrukItem[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([kategori])
  @@index([kode])
}

// =========================
// MODEL PEMBELIAN (STOCK MASUK)
// =========================

model Pembelian {
  id              String          @id @default(uuid())
  itemId          String
  jumlah          Int
  tanggal         DateTime
  supplier        String?         // nama supplier/toko
  hargaSatuan     Int             // harga per satuan dalam rupiah
  totalHarga      Int             // jumlah * hargaSatuan
  keterangan      String?         // catatan tambahan

  item            Item            @relation(fields: [itemId], references: [id])

  createdAt       DateTime        @default(now())

  @@index([itemId])
  @@index([tanggal])
}

// =========================
// MODEL PENGELUARAN (STOCK KELUAR)
// =========================

model Pengeluaran {
  id              String          @id @default(uuid())
  itemId          String
  jumlah          Int
  tanggal         DateTime
  keperluan       String          // untuk siapa/apa
  penerima        String?         // nama penerima
  keterangan      String?         // catatan tambahan

  item            Item            @relation(fields: [itemId], references: [id])

  createdAt       DateTime        @default(now())

  @@index([itemId])
  @@index([tanggal])
}

// =========================
// MODEL ABSENSI
// =========================

model Absensi {
  id                String            @id @default(uuid())
  karyawanId        String
  tanggal           DateTime
  jam               DateTime?         // Jam masuk dari fingerprint
  
  statusKehadiran   StatusKehadiran   @default(HADIR)
  isManual          Boolean           @default(false)  // false = dari fingerprint, true = input manual
  
  keterangan        String?           // Alasan sakit/izin/WFH jika manual
  diinputOleh       String?           // Siapa yang input (untuk manual)
  
  karyawan          Karyawan          @relation(fields: [karyawanId], references: [id])
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@unique([karyawanId, tanggal])
  @@index([tanggal])
  @@index([statusKehadiran])
}

// =========================
// MODEL BUDGET (UNTUK STRUK PEMBELIAN)
// =========================

model Budget {
  id            String      @id @default(uuid())
  bulan         Int         // 1-12 (Januari-Desember)
  tahun         Int
  totalBudget   Int         // Total budget dalam rupiah
  
  struk         Struk[]
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@unique([bulan, tahun])
  @@index([tahun, bulan])
}

// =========================
// MODEL LABEL STRUK
// (Label untuk kategorisasi item: food and drink, other, dll)
// =========================

model LabelStruk {
  id            String      @id @default(uuid())
  nama          String      @unique  // "Food and Drink", "Other", dll
  deskripsi     String?
  warna         String?     // Untuk UI (hex color)
  isAktif       Boolean     @default(true)
  
  strukItem     StrukItem[]
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([isAktif])
}

// =========================
// MODEL STRUK PEMBELIAN
// =========================

model Struk {
  id                String      @id @default(uuid())
  budgetId          String
  tanggal           DateTime
  nomorStruk        String?     @unique // Nomor struk dari toko (opsional, unique jika ada)
  fileBukti         String?     // Path/file name untuk upload bukti struk (opsional)
  namaFileAsli      String?     // Nama file asli saat diupload (untuk display)
  
  totalHarga        Int         // Total harga sebelum tax dan discount
  totalDiscount     Int         @default(0)  // Total discount dari semua item
  taxPersen         Decimal?    // Tax dalam persen (opsional, bisa null)
  taxNominal        Int?        // Tax dalam nominal (opsional, bisa null)
  totalSetelahTax   Int         // Total akhir setelah tax
  
  keterangan        String?     // Catatan tambahan
  
  budget            Budget      @relation(fields: [budgetId], references: [id])
  strukItem         StrukItem[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([budgetId])
  @@index([tanggal])
  @@index([nomorStruk])
}

// =========================
// MODEL ITEM STRUK
// (Item-item dalam satu struk)
// =========================

model StrukItem {
  id                String          @id @default(uuid())
  strukId           String
  labelStrukId      String
  
  namaItem          String          // Nama item (bisa dari Item atau custom)
  itemId            String?         // Relasi ke Item jika ada (opsional)
  
  harga             Int             // Harga per satuan
  qty               Int             // Quantity
  subtotal          Int             // harga * qty (sebelum discount)
  
  // Discount
  discountType      TipeDiscount?   // BONUS atau PERSEN (opsional)
  discountValue     Int?            // Nilai discount (nominal jika BONUS, persen jika PERSEN)
  discountNominal   Int             @default(0)  // Nominal discount yang dihitung
  totalSetelahDiscount Int          // subtotal - discountNominal
  
  keterangan        String?         // Catatan untuk item ini
  
  struk             Struk          @relation(fields: [strukId], references: [id])
  labelStruk        LabelStruk     @relation(fields: [labelStrukId], references: [id])
  item              Item?          @relation(fields: [itemId], references: [id])
  
  createdAt         DateTime        @default(now())
  
  @@index([strukId])
  @@index([labelStrukId])
  @@index([itemId])
}
